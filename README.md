
[**RU**](README.updated.ru.md) | [EN](README.updated.md)

----------

# Indoor-навигация для ОС Аврора (На базе Ble-scanner)

Проект расширяет функционал исходного `ru.auroraos.BleScanner`, демонстрирующего работу с библиотекой SimpleBLE — кроссплатформенной библиотекой для Bluetooth Low Energy (BLE), разработанной для простоты использования API BlueZ 5 DBus. Теперь приложение не только сканирует пространство, выводит список устройств с адресами и именами, но и реализует триангуляцию положения на основе RSSI от BLE-маяков, отображение позиции на карте и улучшенную диагностику. Поддерживаются методы подключения к устройствам и вывод сервисов с характеристиками.

Статус сборки:

1.  example -[](https://gitlab.com/omprussia/examples/BleScanner/-/commits/example)
2.  dev -[](https://gitlab.com/omprussia/examples/BleScanner/-/commits/dev)

## Содержание

1.  [Содержание](#C%D0%BE%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D0%BD%D0%B8%D0%B5)
2.  [Совместимость](#%D0%A1%D0%BE%D0%B2%D0%BC%D0%B5%D1%81%D1%82%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D1%8C)
3.  [Особенности использования и сборки](#%D0%9E%D1%81%D0%BE%D0%B1%D0%B5%D0%BD%D0%BD%D0%BE%D1%81%D1%82%D0%B8-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%B8-%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B8)
4.  [Информация о ветках](#%D0%98%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%86%D0%B8%D1%8F-%D0%BE-%D0%B2%D0%B5%D1%82%D0%BA%D0%B0%D1%85)
5.  [Установка и запуск](#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%B8-%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA)
6.  [Скриншоты](#%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%D1%8B)
7.  [Структура проекта](#%D0%A1%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0)
8.  [Правила использования и участие в разработке](#%D0%9F%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D0%B0-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%B8-%D1%83%D1%87%D0%B0%D1%81%D1%82%D0%B8%D0%B5-%D0%B2-%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B5)
9.  [Доработки проекта](#%D0%94%D0%BE%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B8-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0)
    -   [Добавление триангуляции и расчёта положения](#%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D1%82%D1%80%D0%B8%D0%B0%D0%BD%D0%B3%D1%83%D0%BB%D1%8F%D1%86%D0%B8%D0%B8-%D0%B8-%D1%80%D0%B0%D1%81%D1%87%D1%91%D1%82%D0%B0-%D0%BF%D0%BE%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F)
    -   [Обновление координат маяков](#%D0%9E%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BA%D0%BE%D0%BE%D1%80%D0%B4%D0%B8%D0%BD%D0%B0%D1%82-%D0%BC%D0%B0%D1%8F%D0%BA%D0%BE%D0%B2)
    -   [Отображение позиции на карте](#%D0%9E%D1%82%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BD%D0%B0-%D0%BA%D0%B0%D1%80%D1%82%D0%B5)
    -   [Синхронизация bleScanModel](#%D0%A1%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-blescanmodel)
    -   [Диагностика и отладка](#%D0%94%D0%B8%D0%B0%D0%B3%D0%BD%D0%BE%D1%81%D1%82%D0%B8%D0%BA%D0%B0-%D0%B8-%D0%BE%D1%82%D0%BB%D0%B0%D0%B4%D0%BA%D0%B0)
    -   [Обработка ошибок и стабильность](#%D0%9E%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0-%D0%BE%D1%88%D0%B8%D0%B1%D0%BE%D0%BA-%D0%B8-%D1%81%D1%82%D0%B0%D0%B1%D0%B8%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C)
    -   [Сами маяки](#%D0%A1%D0%B0%D0%BC%D0%B8-%D0%BC%D0%B0%D1%8F%D0%BA%D0%B8)
    -   [Карта](#%D0%9A%D0%B0%D1%80%D1%82%D0%B0)

## Совместимость

Проект совместим со всеми текущими версиями ОС Аврора.

## Особенности использования и сборки

Данный пример-приложение собирается с помощью Аврора SDK: [Документация](https://developer.auroraos.ru/doc/sdk/app_development/work/create/examples#build)

## Информация о ветках

[Ветки](https://developer.auroraos.ru/doc/software_development/examples#branches)

## Установка и запуск

Проект собирается обычным образом с помощью Аврора SDK: [Документация](https://developer.auroraos.ru/doc/sdk/app_development/work/build).

## Снимки экранов

## Структура проекта

Проект имеет стандартную структуру приложения на C++ и QML для ОС Аврора.

-   Файл **[ru.auroraos.BleScanner.pro](ru.auroraos.BleScanner.pro)** описывает проект подкаталогов, который содержит два подпроекта, первый из которых отвечает за сборку библиотеки SimpleBLE, а второй описывает структуру приложения для системы сборки qmake.
-   Каталог **[icons](app/icons)** содержит значки приложений для разных разрешений экрана.
-   Каталог **[qml](app/qml)** содержит исходный код QML и ресурсы пользовательского интерфейса.
    -   Каталог **[cover](app/qml/cover)** содержит реализации оболочек приложений.
    -   Каталог **[icons](app/qml/icons)** содержит дополнительные иконки интерфейса пользователя.
    -   Каталог **[pages](app/qml/pages)** содержит страницы приложения.
    -   Файл **[BleScanner.qml](app/qml/BleScanner.qml)** обеспечивает реализацию окна приложения.
-   Каталог **[rpm](rpm)** содержит настройки сборки rpm-пакета. Файл **[ru.auroraos.BleScanner.spec](rpm/ru.auroraos.BleScanner.spec)** используется инструментом rpmbuild.
-   Каталог **[src](app/src)** содержит исходный код C++.
    -   Файл **[main.cpp](app/src/main.cpp)** является точкой входа приложения.
-   Каталог **[translations](app/translations)** содержит файлы перевода пользовательского интерфейса.
-   Файл **[ru.auroraos.BleScanner.desktop](app/ru.auroraos.BleScanner.desktop)** определяет отображение и параметры запуска приложения.

## Правила использования и участие в разработке

Исходный код проекта предоставляется по [лицензии](LICENSE.BSD-3-CLAUSE.md), которая позволяет использовать его в сторонних приложениях.

[Лицензионное соглашение с участником](https://gitlab.com/omprussia/wiki/-/wikis/CLA.ru) [Соглашение участника](CONTRIBUTING.md) регламентирует права, предоставляемые участниками компании «Открытая Мобильная Платформа».

Информация об участниках указана в файле [AUTHORS](AUTHORS.md).

[Кодекс поведения](CODE_OF_CONDUCT.md) — это действующий набор правил компании «Открытая Мобильная Платформа», который информирует об ожиданиях по взаимодействию между членами сообщества при общении и работе над проектами.

## Доработки проекта

### Добавление триангуляции и расчёта положения

Целью доработки было определить положение устройства в пространстве на основе сигналов от четырёх BLE-маяков (ESP32_PICO_V3_BLE_1 до ESP32_PICO_V3_BLE_4). Для этого была внедрена триангуляция, использующая классическую трилатерацию с тремя маяками для вычисления координат (x, y) в метрах через систему уравнений расстояний. Альтернативно добавлен метод Nearest Neighbor, определяющий позицию как координаты маяка с максимальным RSSI. Расчёт расстояния реализован через метод `calculateDistance(int rssi)`, основанный на эмпирической модели затухания сигнала (FSPL) с начальным значением -59 dBm на 1 метр и затуханием 2 dB на удвоение расстояния. Реализация находится в `blescanmodel.cpp`: `triangulatePosition()`  выводит расстояния и позицию в `qdebug()`, `nearestNeighborPosition()` выбирает ближайший маяк, а `calculateTriangulation()` и `calculateNearestNeighbor()`  обновляют `m_position`. Эти методы объявлены в `blescanmodel.h` с `Q_INVOKABLE` для доступа из QML.

### Обновление координат маяков

Целью было адаптировать систему к новым координатам маяков, отсчитываемым от левого нижнего угла карты, где каждая клетка равна 10 см. Координаты обновлены на основе данных: Z1 (1.3, 9.0), Z2 (11.2, 6.9), Z3 (11.3, 2.7), Z4 (5.6, 1.6) м. Изменения реализованы в `triangulatePosition()` и `nearestNeighborPosition()` в `blescanmodel.cpp`, где координаты хранятся в `QMap<QString, QPointF> beaconPositions`.

### Отображение положения на карте

Целью было отобразить посчитанную позицию как синюю точку на карте (`MapPage.qml`) с перерисовкой по кнопке. Метод `positionInPixels()` преобразует метры в пиксели карты (114×92 пикселя, соответствующие 11.4×9.2 м), реализован в `blescanmodel.cpp`. Визуализация выполнена через `Rectangle` в `MapPage.qml` с цветом "blue" и размером 20×20. Свойство `position` с сигналом `positionChanged` добавлено для обновления QML.

### Синхронизация bleScanModel

Целью было устранить проблему с разными экземплярами `bleScanModel`. Теперь он глобален, определён в `MainPage.qml` и передаётся в `MapPage.qml` через параметр `bleModel`. Локальное создание в `MapPage.qml` убрано. Реализация: кнопка "Map View" в `MainPage.qml`  использует `pageStack.push(..., {bleModel: bleScanModel})`, а `MapPage.qml` принимает `property var bleModel: null` с проверкой.

### Диагностика и отладка

Целью было улучшить трассировку для устранения ошибок. Добавлены `qDebug()` в `positionInPixels()`, `triangulatePosition()`, и `updateDiagnosticMessage()` в `blescanmodel.cpp` .

### Обработка ошибок и стабильность

Целью было устранить некорректные значения трилатерации (например, 175, 151 м). Добавлены проверки валидности расстояний и ограничение результата (0–11.4 м, 0–9.2 м) в `triangulatePosition()` в `blescanmodel.cpp` с использованием `qBound()`. Так же предусмотрена возможность добавлять на карту "мертвые зоны". В CSV-файле с картой помещения для обозначения новой площадь с "мертвой зоной" используется символ "B".

### Маяки

Маяки реализованы на ESP32-pico-v3 с мощностью передачи 9 dBm в прошивке. Использование ESP32 обусловлено их доступностью, поддержкой BLE и возможностью программирования для передачи идентификаторов (например, "ESP32_PICO_V3_BLE_1" до "ESP32_PICO_V3_BLE_4"). Взаимодействие с маяками осуществляется через `updateDeviceInfo()` в `blescanmodel.cpp`.
При использовании проекта в помещениях в большей площадью рекомендуется выбрать в качестве аппаратной основы модели ESP32, имеющие IPEX коннектор для 2.4 GHz антенны, в соответствии с частотой стандарта Bluetooth Low Energy. Так зона покрытия станет выше, что потребует меньшего количества маяков. Внимание! При использовании такого решения, или иного, отличного от данного требуется произвести перерасчет параметров TX power и других для выявления разницы в коэффициентах затухания сигнала и других, используемых при расчетах. Расчетные формулы приведены в документации.

### Карта

Карта представлена `kartasmall.png` в `MapPage.qml` с размером 114×92 пикселя (11.4×9.2 метра, каждая клетка 10 см). Используются маркеры: "B" для запретных зон, "X" для пустых мест, "Z1"–"Z4" для маяков, отображаемых зелёными точками через `Grid` и `Repeater` с данными из `gridData` модели `BleScanModel`. Маркеры содержатся в CSV файле. На данном этапе проекта этот файл с картой тестового помещения лежит в директории qml/icons. Но так же присутствует закомментированная часть кода, реализующая скачивание файла с картой помещения с сервера. (Предполагается что в реальных условиях для использования проекта для навигации, клиент сначала скачает карту требуемого помещения с сервера. Для реализации серверной части предполагается использовать еще одно устройство/модифицировать устаревшую версию прошивки для одного из действующих маяков. К сожалению, второй вариант не рекомендуется, так как одновременное использование Wi-Fi и BLE на маяках может отразиться на их способности стабильно передавать тот же уровень сигнала, а это критично для расчета местоположения клиента.

### To-do

Проект на данный момент активен и предлагает дополнительные возможности для его развития. На момент написания документации имеются заготовки для RSSI fingerprinting и IMU Fusion с использованием акселерометра и иных датчиков, с последующим применением фильтра Калмана для получения позиции, используя данные не только о BLE RSSI.

Имеется проблема с отрисовкой положения клиента (Urgent)

Пока в закомментированном состоянии находится код, отвечающий за связь с сервером для скачивания карты помещения

Пока в закомментированном состоянии находится код, отвечающий за связь с сервером для передачи актуального местоположения

В версии сервера, использующей 3D презентацию помещения имеются несколько ошибок в части подсчета Wifi RSSI (потенциал для опеределения ситуации, когда маяк перенесли/снесли/повредили), уровень заряда. Уровень заряда на данный момент определялся при помощи АЦП. Предполагается использовать отдельный модуль для получения уровня заряда аккумулятора. Решение с делителем напряжения на данный момент скорее экспериментальное, чем практичное.

В репозитории имеется файл, содержащий 3D модель корпуса для маяка. Он предполагает наличие аккумулятора вплоть до 3S-18650 аккумулятора с номинальным напряжением 3,7В, три светодиода для индикации ошибок/уровень заряда, kill-switch.

<p>Автор: Костин Арсений (@arskstn)</p>
<p>Автор прошлой версии прошивки: Максим Симдянов (@NotoriusM)</p>
<p>Автор изначального проекта: Общество с ограниченной ответственностью «Открытая мобильная платформа», документация изначального проекта находится в директории с приложением.</p>
